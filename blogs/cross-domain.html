<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>九种 “姿势” 让你彻底解决跨域问题 | 张垒的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="记录好的技术文档">
    
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.06cff2a7.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.5d9f3e6e.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/7.52cd3cfd.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.5e77f0d2.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/1.c3e4b76d.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/60.d0b6fce9.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.fce7151c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.665820a8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.1cfbcfc6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.06542fc4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/16.5a7a423b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/17.d2f8beac.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.3366a66f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/19.a0f84501.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.8cf233fc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.d142c8ff.js"><link rel="prefetch" href="/vuepress-blog/assets/js/22.3f0558f8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.7f170fad.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.ca3d8f1b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/25.e8704ed0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/26.ea2f5a39.js"><link rel="prefetch" href="/vuepress-blog/assets/js/27.87921c42.js"><link rel="prefetch" href="/vuepress-blog/assets/js/28.f31d39ff.js"><link rel="prefetch" href="/vuepress-blog/assets/js/29.5c2c99a1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.eff7fee9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/30.b375e77b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/31.e44aa03f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/32.82fe56b9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/33.c7707b2a.js"><link rel="prefetch" href="/vuepress-blog/assets/js/34.5977256e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/35.7648c433.js"><link rel="prefetch" href="/vuepress-blog/assets/js/36.0d04e6fc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/37.f85a8b69.js"><link rel="prefetch" href="/vuepress-blog/assets/js/38.a49efe7f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/39.98053ef4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.15d7a48b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/40.2ed1c6b3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/41.665e6da9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/42.bba66369.js"><link rel="prefetch" href="/vuepress-blog/assets/js/43.0102712f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/44.fc0cf83d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/45.b24876fd.js"><link rel="prefetch" href="/vuepress-blog/assets/js/46.999a2df2.js"><link rel="prefetch" href="/vuepress-blog/assets/js/47.5cfca3d0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/48.d70d2f6c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/49.80d9cea6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.fb9624e5.js"><link rel="prefetch" href="/vuepress-blog/assets/js/50.ca82dac4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/51.a6b49e93.js"><link rel="prefetch" href="/vuepress-blog/assets/js/52.7f08f076.js"><link rel="prefetch" href="/vuepress-blog/assets/js/53.2a888b74.js"><link rel="prefetch" href="/vuepress-blog/assets/js/54.b39c22d6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/55.a9a9bc24.js"><link rel="prefetch" href="/vuepress-blog/assets/js/56.c9ba9d63.js"><link rel="prefetch" href="/vuepress-blog/assets/js/57.af85ad1c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/58.b21e620f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/59.604943d3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.09f6a933.js"><link rel="prefetch" href="/vuepress-blog/assets/js/61.54065b41.js"><link rel="prefetch" href="/vuepress-blog/assets/js/62.f0028e7f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/63.195ddca5.js"><link rel="prefetch" href="/vuepress-blog/assets/js/64.761c82aa.js"><link rel="prefetch" href="/vuepress-blog/assets/js/65.6002006f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/66.97ef0021.js"><link rel="prefetch" href="/vuepress-blog/assets/js/67.ac085f10.js"><link rel="prefetch" href="/vuepress-blog/assets/js/68.e3587494.js"><link rel="prefetch" href="/vuepress-blog/assets/js/69.22b18dd6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/70.017b9424.js"><link rel="prefetch" href="/vuepress-blog/assets/js/71.1c39dd94.js"><link rel="prefetch" href="/vuepress-blog/assets/js/8.0899600d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/9.1f42c771.js"><link rel="prefetch" href="/vuepress-blog/assets/js/vendors~docsearch.680926dd.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.06cff2a7.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>张垒的博客</h3> <p class="description" data-v-59e6cb88>记录好的技术文档</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">张垒的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/刷题/" class="nav-link"><i class="undefined"></i>
  刷题
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      zhang lei 的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/4495277269197975" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/zerle" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/vuepress-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/vuepress-blogme.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>33</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>31</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/刷题/" class="nav-link"><i class="undefined"></i>
  刷题
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      zhang lei 的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/4495277269197975" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/zerle" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/vuepress-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>九种 “姿势” 让你彻底解决跨域问题</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">九种 “姿势” 让你彻底解决跨域问题</h1> <div data-v-8a445198><!----> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2021/2/28</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>跨域</span></i></div></div> <div class="theme-reco-content content__default"><h2 id="同源策略"><a href="#同源策略" class="header-anchor">#</a> 同源策略</h2> <p>同源策略 SOP（Same origin policy）是一种约定，由 Netscape 公司 1995 年引入浏览器，它是浏览器最核心也最基本的安全功能，如果缺少了同源策略，浏览器很容易受到 XSS、CSRF 等攻击。所谓同源是指 “协议 + 域名 + 端口” 三者相同，即便两个不同的域名指向同一个 ip 地址，也非同源。</p> <h2 id="什么是跨域"><a href="#什么是跨域" class="header-anchor">#</a> 什么是跨域？</h2> <p>当协议、域名、端口号，有一个或多个不同时，有希望可以访问并获取数据的现象称为跨域访问，同源策略限制下 cookie、localStorage、dom、ajax、IndexDB 都是不支持跨域的。</p> <p>假设 cookie 支持了跨域，http 协议无状态，当用户访问了一个银行网站登录后，银行网站的服务器给返回了一个 sessionId，当通过当前浏览器再访问一个恶意网站，如果 cookie 支持跨域，恶意网站将获取 sessionId 并访问银行网站，出现安全性问题；IndexDB、localStorage 等数据存储在不同域的页面切换时是获取不到的；假设 Dom 元素可以跨域，在自己的页面写入一个 iframe 内部嵌入的地址是www.baidu.com， 当在百度页面登录账号密码时就可以在自己的页面获取百度的数据信息，这显然是不合理的。</p> <p>这就是为什么 cookie、localStorage、dom、ajax、IndexDB 会受到同源策略会限制，下面还有一点对跨域理解的误区：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>* 误区：同源策略限制下，访问不到后台服务器的数据，或访问到后台服务器的数据后没有返回；
* 正确：同源策略限制下，可以访问到后台服务器的数据，后台服务器会正常返回数据，而被浏览器给拦截了。
</code></pre></div><h2 id="实现跨域的方式"><a href="#实现跨域的方式" class="header-anchor">#</a> 实现跨域的方式</h2> <h3 id="_1-使用-jsonp-跨域"><a href="#_1-使用-jsonp-跨域" class="header-anchor">#</a> 1.使用 jsonp 跨域</h3> <p>使用场景：当自己的项目前端资源和后端部署在不同的服务器地址上，或者其他的公司需要访问自己对外公开的接口，需要实现跨域获取数据，如百度搜索。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/* 封装 jsonp */
// 封装 jsonp 跨域请求的方法
<span class="token keyword">function</span> jsonp<span class="token punctuation">(</span><span class="token punctuation">{</span> url, params, cb <span class="token punctuation">}</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">return</span> new Promise<span class="token punctuation">((</span>resolve, reject<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    // 创建一个 script 标签帮助我们发送请求
    <span class="token builtin class-name">let</span> script <span class="token operator">=</span> document.createElement<span class="token punctuation">(</span><span class="token string">'script'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    const arr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>
    params <span class="token operator">=</span> <span class="token punctuation">{</span> <span class="token punctuation">..</span>.params, cb <span class="token punctuation">}</span><span class="token punctuation">;</span>

    // 循环构建键值对形式的参数
    <span class="token keyword">for</span> <span class="token punctuation">(</span>let key <span class="token keyword">in</span> params<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      arr.push<span class="token punctuation">(</span>key + <span class="token string">'='</span> + params<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    // 创建全局函数
    window<span class="token punctuation">[</span>cb<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      resolve<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      // 在跨域拿到数据以后将 script 标签销毁
      document.body.removeChild<span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>

    // 拼接发送请求的参数并赋值到 src 属性
    script.src <span class="token operator">=</span> url + <span class="token string">'?'</span> arr.join<span class="token punctuation">(</span><span class="token string">'&amp;'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    document.body.appendChild<span class="token punctuation">(</span>script<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

// 调用方法跨域请求百度搜索的接口
json<span class="token punctuation">(</span><span class="token punctuation">{</span>
  url: <span class="token string">'https://sp0.baidu.com/5a1Fazu8AA54nxGko9WTAnF6hhy/su'</span>,
  params: <span class="token punctuation">{</span>
    wd: <span class="token string">'jsonp'</span>
  <span class="token punctuation">}</span>,
  cb: <span class="token string">'show'</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>.then<span class="token punctuation">(</span>data <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
  // 打印请求回的数据
  console.log<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h4 id="缺点"><a href="#缺点" class="header-anchor">#</a> 缺点：</h4> <p>只能发送 get 请求，不支持 post、put、delete 等；
不安全，容易引发 xss 攻击，会把别人的脚本引入到自己的页面中执行，如：弹窗、广告等，甚至更危险的脚本程序，如在返回的结果中返回了下面代码。</p> <h3 id="_2-使用-cors-跨域"><a href="#_2-使用-cors-跨域" class="header-anchor">#</a> 2.使用 CORS 跨域</h3> <p>跨源资源共享 CORS（Cross-Origin Resource Sharing）是 W3C 的一个工作草案，定义了在必须访问跨源资源时，浏览器与服务器应该如何沟通。CORS 背后的基本思想，就是使用自定义的 HTTP 头部让浏览器与服务器进行沟通，从而决定请求或响应是应该成功，还是应该失败。</p> <h4 id="使用场景-多用于开发时-前端与后台在不同的-ip-地址下进行数据访问。"><a href="#使用场景-多用于开发时-前端与后台在不同的-ip-地址下进行数据访问。" class="header-anchor">#</a> 使用场景：多用于开发时，前端与后台在不同的 ip 地址下进行数据访问。</h4> <p>现在启动两个端口号不同的服务器，创建跨域条件，服务器（Node.js）代码如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/* 服务端代码 */
// 服务器1
const express <span class="token operator">=</span> require<span class="token punctuation">(</span>express<span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

// 服务器2
const express <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.get<span class="token punctuation">(</span><span class="token string">'/getDate'</span>, <span class="token keyword">function</span> <span class="token punctuation">(</span>req, res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res.end<span class="token punctuation">(</span><span class="token string">'I love you'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>由于我们的 Node.js 服务器使用 express 框架，在我们的项目根目录下的命令行中输入下面代码进行安装：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> express <span class="token parameter variable">--save</span>
</code></pre></div><p>通过访问 http://localhost:3000/index.html 获取 index.html 文件并执行其中的 Ajax 请求 http://localhost:4000/getDate 接口去获取数据，index.html 文件内容如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：index.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>CORS 跨域<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    const xhr <span class="token operator">=</span> new XMLHttpRequest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 正常 cookie 是不允许跨域的
    document.cookie <span class="token operator">=</span> <span class="token string">'name=hello'</span><span class="token punctuation">;</span>

    // cookie 想要实现跨域必须携带凭证
    xhr.withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    // xhr.open<span class="token punctuation">(</span><span class="token string">'GET'</span>, <span class="token string">'http://localhost:4000/getDate'</span>, <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr.open<span class="token punctuation">(</span><span class="token string">'PUT'</span>, <span class="token string">'http://localhost:4000/getDate'</span>, <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 设置名为 name 的自定义请求头
    xhr.setRequestHeader<span class="token punctuation">(</span><span class="token string">'name'</span>, <span class="token string">'hello'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    xhr.onreadystatechange <span class="token operator">=</span> <span class="token function-name function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr.readyState <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr.status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr.status <span class="token operator">&lt;</span> <span class="token number">300</span> <span class="token operator">||</span> xhr.status <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          // 打印返回的数据
          console.log<span class="token punctuation">(</span>xhr.response<span class="token punctuation">)</span><span class="token punctuation">;</span>

          // 打印后台设置的自定义头信息
          console.log<span class="token punctuation">(</span>xhr.getResponseHeader<span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    xhr.send<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><p>上面 index.html 代码中发送请求访问不在同源的服务器 2，此时会在控制台给出错误信息，告诉我们缺少了哪些响应头，我们对应报错信息去修改访问的服务器 2 的代码，添加对应的响应头，实现 CORS 跨域。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/* 服务端代码 */
// 服务器2
const express <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

// 允许访问域的白名单
const whiteList <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token string">'http://localhost:3000'</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

app.use<span class="token punctuation">(</span>function <span class="token punctuation">(</span>req, res, next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">let</span> origin <span class="token operator">=</span> req.header.origin<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>whiteList.includes<span class="token punctuation">(</span>origin<span class="token punctuation">))</span> <span class="token punctuation">{</span>
    // 设置那个源可以访问我，参数为 * 时
    // 允许任何人访问，但是不可以和 cookie 凭证的响应头共同使用
    res.setHeader<span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span>, origin<span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 想要获取 ajax 的头信息，需设置响应头
    res.setHeader<span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Headers'</span>, <span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 处理复杂请求的头
    res.setHeader<span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Methods'</span>, <span class="token string">'PUT'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 允许发送 cookie 凭证的响应头
    res.setHeader<span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Credentials'</span>, <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 允许前端获取哪个头信息
    res.setHeader<span class="token punctuation">(</span><span class="token string">'Access-Control-Expose-Headers'</span>, <span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 处理 OPTIONS 预检的存活时间，单位 s
    res.setHeader<span class="token punctuation">(</span><span class="token string">'Access-Control-Max-Age'</span>, <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 发送 PUT 请求会做一个试探性的请求 OPTIONS
    // 其实是请求了两次，当接收的请求为 OPTIONS 时不做任何处理
    <span class="token keyword">if</span> <span class="token punctuation">(</span>req.method <span class="token operator">==</span><span class="token operator">=</span> <span class="token string">'OPTIONS'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res.end<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  next<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app.put<span class="token punctuation">(</span><span class="token string">'/getDate'</span>, <span class="token keyword">function</span> <span class="token punctuation">(</span>req, res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  // res.setHeader<span class="token punctuation">(</span><span class="token string">'name'</span>, <span class="token string">'nihao'</span><span class="token punctuation">)</span><span class="token punctuation">;</span> // 设置自定义响应头信息
  res.end<span class="token punctuation">(</span><span class="token string">'I love you'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app.get<span class="token punctuation">(</span><span class="token string">'/getDate'</span>, <span class="token keyword">function</span> <span class="token punctuation">(</span>req, res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  res.end<span class="token punctuation">(</span><span class="token string">'I love you'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_3-使用-postmessage-实现跨域"><a href="#_3-使用-postmessage-实现跨域" class="header-anchor">#</a> 3.使用 postMessage 实现跨域</h3> <p>postMessage 是 H5 的新 API，跨文档消息传送（cross-document messaging），有时候简称为 XMD，指的是在来自不同域的页面间传递消息。</p> <p>调用方式：window.postMessage(message, targetOrigin)</p> <ul><li>message：发送的数据</li> <li>targetOrigin：发送的窗口的域</li></ul> <p>在对应的页面中用 message 事件接收，事件对象中有 data、origin、source 三个重要信息：</p> <ul><li>data：接收到的数据</li> <li>origin：接收到数据源的域（数据来自哪个域）</li> <li>source：接收到数据源的窗口对象（数据来自哪个窗口对象）</li></ul> <p>使用场景：不是使用 Ajax 的数据通信，更多是在两个页面之间的通信，在 A 页面中引入 B 页面，在 A、B 两个页面之间通信。</p> <p>与上面 CORS 类似，我们要创建跨域场景，搭建两个端口号不同的 Node.js 服务器，后面相同方式就不多赘述了。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/* 服务端代码 */
// 服务器1
const express <span class="token operator">=</span> require<span class="token punctuation">(</span>express<span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

// 服务器2
const express <span class="token operator">=</span> require<span class="token punctuation">(</span>express<span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>通过访问 http://localhost:3000/a.html，在 a.html 中使用 iframe 标签引入 http://localhost:4000/b.html，在两个窗口间传递数据。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：a.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面 A<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>iframe <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;http://localhost:4000/b.html&quot;</span> <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token string">&quot;frame&quot;</span> <span class="token assign-left variable">onload</span><span class="token operator">=</span><span class="token string">&quot;load()&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>/iframe<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    <span class="token keyword">function</span> <span class="token function-name function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin class-name">let</span> frame <span class="token operator">=</span> document.getElementById<span class="token punctuation">(</span><span class="token string">'frame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      frame.contentWindow.postMessage<span class="token punctuation">(</span><span class="token string">'I love you'</span>, <span class="token string">'http://localhost:4000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      window.onmessage <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        console.log<span class="token punctuation">(</span>e.data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：b.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面 B<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    window.onmessage <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      // 打印来自页面 A 的消息
      console.log<span class="token punctuation">(</span>e.data<span class="token punctuation">)</span><span class="token punctuation">;</span>
      // 给页面 A 发送回执
      e.source.postMessage<span class="token punctuation">(</span><span class="token string">'I love you, too'</span>, e.origin<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><h3 id="_4-使用-window-name-实现跨域"><a href="#_4-使用-window-name-实现跨域" class="header-anchor">#</a> 4.使用 window.name 实现跨域</h3> <p>同样是页面之间的通信，需要借助 iframe 标签，A 页面和 B 页面是同域的 http://localhost:3000，C 页面在独立的域 http://localhost:4000。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/* 服务端代码 */
// 服务器1
const express <span class="token operator">=</span> require<span class="token punctuation">(</span>express<span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

// 服务器2
const express <span class="token operator">=</span> require<span class="token punctuation">(</span>express<span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>实现思路：在 A 页面中将 iframe 的 src 指向 C 页面，在 C 页面中将属性值存入 window.name 中，再把 iframe 的 src 换成同域的 B 页面，在当前的 iframe 的 window 对象中取出 name 的值，访问 http://localhost:3000/a.html。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：a.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面 A<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>iframe <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;http://localhost:4000/c.html&quot;</span> <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token string">&quot;frame&quot;</span> <span class="token assign-left variable">onload</span><span class="token operator">=</span><span class="token string">&quot;load()&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>/iframe<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    // 增加一个标识，第一次触发 load 时更改地址，更改后再次触发直接取值
    <span class="token builtin class-name">let</span> isFirst <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-name function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token builtin class-name">let</span> frame <span class="token operator">=</span> document.getElementById<span class="token punctuation">(</span><span class="token string">'frame'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>isFirst<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        frame.src <span class="token operator">=</span> <span class="token string">'http://localhost:3000/b.html'</span><span class="token punctuation">;</span>
        isFirst <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        console.log<span class="token punctuation">(</span>frame.contentWindow.name<span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：c.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面 C<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    window.name <span class="token operator">=</span> <span class="token string">'I love you'</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><h3 id="_5-使用-location-hash-实现跨域"><a href="#_5-使用-location-hash-实现跨域" class="header-anchor">#</a> 5.使用 location.hash 实现跨域</h3> <p>与 window.name 跨域的情况相同，是不同域的页面间的参数传递，需要借助 iframe 标签，A 页面和 B 页面是同域的 http://localhost:3000，C 页面是独立的域 http://localhost:4000。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/* 服务端代码 */
// 服务器1
const express <span class="token operator">=</span> require<span class="token punctuation">(</span>express<span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

// 服务器2
const express <span class="token operator">=</span> require<span class="token punctuation">(</span>express<span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">4000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>实现思路：A 页面通过 iframe 引入 C 页面，并给 C 页面传一个 hash 值，C 页面收到 hash 值后创建 iframe 引入 B 页面，把 hash 值传给 B 页面，B 页面将自己的 hash 值放在 A 页面的 hash 值中，访问 http://localhost:3000/a.html。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：a.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面 A<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>iframe <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;http://localhost:4000/c.html#Iloveyou&quot;</span> <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token string">&quot;frame&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>/iframe<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    // 使用 hashchange 事件接收来自 B 页面设置给 A 页面的 <span class="token builtin class-name">hash</span> 值
    window.onhashchange <span class="token operator">=</span> <span class="token function-name function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console.log<span class="token punctuation">(</span>location.hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：a.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面 A<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>iframe <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;http://localhost:4000/c.html#Iloveyou&quot;</span> <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token string">&quot;frame&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>/iframe<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    // 使用 hashchange 事件接收来自 B 页面设置给 A 页面的 <span class="token builtin class-name">hash</span> 值
    window.onhashchange <span class="token operator">=</span> <span class="token function-name function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console.log<span class="token punctuation">(</span>location.hash<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：b.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面 B<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    // 将 C 页面引入 B 页面设置的 <span class="token builtin class-name">hash</span> 值设置给 A页面
    window.parent.parent.location.hash <span class="token operator">=</span> location.hash<span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><h3 id="_6-使用-document-domain-实现跨域"><a href="#_6-使用-document-domain-实现跨域" class="header-anchor">#</a> 6.使用 document.domain 实现跨域</h3> <p>使用场景：不是万能的跨域方式，大多使用于同一公司不同产品间获取数据，必须是一级域名和二级域名的关系，如 www.baidu.com 与 video.baidu.com 之间。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/* 服务端代码 */
const express <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>想要模拟使用 document.domain 跨域的场景需要做些小小的准备，到 C:\Windows\System32\drivers\etc 该路径下找到 hosts 文件，在最下面创建一个一级域名和一个二级域名。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token number">127.0</span>.0.1   www.domainacross.com
<span class="token number">127.0</span>.0.1   sub.domainacross.com
</code></pre></div><p>命名是随意的，只要是符合一级域名与 二级域名的关系即可，然后访问 http://www.domainacross.com:3000/a.html。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：a.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面 A<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>我是页面 A 的内容<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>iframe
    <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;http://sucess.domainacross.com:3000/b.html&quot;</span>
    <span class="token assign-left variable">onload</span><span class="token operator">=</span><span class="token string">&quot;load()&quot;</span>
    <span class="token assign-left variable">id</span><span class="token operator">=</span><span class="token string">&quot;frame&quot;</span>
  <span class="token operator">&gt;</span><span class="token operator">&lt;</span>/iframe<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    document.domain <span class="token operator">=</span> <span class="token string">'domainacross.com'</span><span class="token punctuation">;</span>
    <span class="token keyword">function</span> <span class="token function-name function">load</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      console.log<span class="token punctuation">(</span>frame.contentWindow.message<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：b.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">name</span><span class="token operator">=</span><span class="token string">&quot;viewport&quot;</span> <span class="token assign-left variable">content</span><span class="token operator">=</span><span class="token string">&quot;width=device-width, initial-scale=1.0&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta http-equiv<span class="token operator">=</span><span class="token string">&quot;X-UA-Compatible&quot;</span> <span class="token assign-left variable">content</span><span class="token operator">=</span><span class="token string">&quot;ie=edge&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面 B<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>p<span class="token operator">&gt;</span>我是 B 页面的内容<span class="token operator">&lt;</span>/p<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    document.domain <span class="token operator">=</span> <span class="token string">'domainacross.com'</span><span class="token punctuation">;</span>
    var message <span class="token operator">=</span> <span class="token string">'Hello A'</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><h3 id="_4-使用-websocket-实现跨域"><a href="#_4-使用-websocket-实现跨域" class="header-anchor">#</a> 4.使用 WebSocket 实现跨域</h3> <p>WebSocket 没有跨域限制，高级 API（不兼容），想要兼容低版本浏览器，可以使用 socket.io 的库，WebSocket 与 HTTP 内部都是基于 TCP 协议，区别在于 HTTP 是单向的（单双工），WebSocket 是双向的（全双工），协议是 ws:// 和 wss:// 对应 http:// 和 https://，因为没有跨域限制，所以使用 file:// 协议也可以进行通信。</p> <p>由于我们在 Node.js 服务中使用了 WebSocket，所以需要安装对应的依赖：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> ws <span class="token parameter variable">--save</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：index.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>页面<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    // 创建 webSocket
    const socket <span class="token operator">=</span> new WebSocket<span class="token punctuation">(</span><span class="token string">'ws://localhost:3000'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    // 连接上触发
    socket.onopen <span class="token operator">=</span> <span class="token function-name function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      socket.send<span class="token punctuation">(</span><span class="token string">'I love you'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    // 收到消息触发
    socket.onmessage <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      // 打印收到的数据
      console.log<span class="token punctuation">(</span>e.data<span class="token punctuation">)</span><span class="token punctuation">;</span> // I love you, too
    <span class="token punctuation">}</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>/* 服务端代码 */
const express <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

// 引入 webSocket
const WebSocket <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'ws'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
// 创建连接，端口号与前端相对应
const wss <span class="token operator">=</span> new WebSocket.Server<span class="token punctuation">(</span><span class="token punctuation">{</span> port: <span class="token number">3000</span> <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

// 监听连接
wss.on<span class="token punctuation">(</span><span class="token string">'connection'</span>, <span class="token keyword">function</span> <span class="token punctuation">(</span>ws<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  // 监听消息
  ws.on<span class="token punctuation">(</span><span class="token string">'message'</span>, <span class="token keyword">function</span> <span class="token punctuation">(</span>data<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    // 打印消息
    console.log<span class="token punctuation">(</span>data<span class="token punctuation">)</span><span class="token punctuation">;</span> // I love you
    // 发送消息
    ws.send<span class="token punctuation">(</span><span class="token string">'I love you, too'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h3 id="_8-使用-nginx-实现跨域"><a href="#_8-使用-nginx-实现跨域" class="header-anchor">#</a> 8.使用 nginx 实现跨域</h3> <p>nginx 本身就是一个服务器，因此我们需要去 nginx 官网下载服务环境 http://nginx.org/en/download.html。</p> <p>下载后解压到一个文件夹中；
双击 nginx.exe 启动（此时可以通过 http://localhost 访问 nginx 服务）；
在目录新建 json 文件夹；
进入 json 文件夹新建 data.json 文件并写入内容；
回到 nginx 根目录进入 conf 文件夹；
使用编辑器打开 nginx.conf 进行配置。</p> <p>data.json 文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">{</span>
  <span class="token string">&quot;name&quot;</span><span class="token builtin class-name">:</span> <span class="token string">&quot;nginx&quot;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>nginx.conf 文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token comment"># nginx 配置</span>
server <span class="token punctuation">{</span>
  <span class="token comment"># ...</span>
  location ~.*<span class="token punctuation">\</span>.json <span class="token punctuation">{</span>
    root json<span class="token punctuation">;</span>
    add_header <span class="token string">&quot;Access-Control-Allow-Origin&quot;</span> <span class="token string">&quot;*&quot;</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
  <span class="token comment"># ...</span>
<span class="token punctuation">}</span>
</code></pre></div><p>含义：</p> <ul><li>~.*.json：代表忽略大小写，后缀名为 json 的文件；</li> <li>root json：代表 json 文件夹；</li> <li>add_header：代表加入跨域的响应头及允许访问的域，* 为允许任何访问。</li></ul> <p>在 nginx 根目录启动 cmd 命令行（Windows 系统必须使用 cmd 命令行）执行下面代码重启 nginx。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ nginx <span class="token parameter variable">-s</span> reload
</code></pre></div><p>不跨域访问：http://localhost/data.json，跨域访问时需要创建跨域条件代码如下：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/* 服务端代码 */
const express <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app.use<span class="token punctuation">(</span>express.static<span class="token punctuation">(</span>__dirname<span class="token punctuation">))</span><span class="token punctuation">;</span>
app.listen<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>跨域访问：http://localhost:3000/index.html</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：index.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>nginx跨域<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    const xhr <span class="token operator">=</span> new XMLHttpRequest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr.open<span class="token punctuation">(</span><span class="token string">'GET'</span>, <span class="token string">'http://localhost/data.json'</span>, <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr.onreadystatechange <span class="token operator">=</span> <span class="token function-name function">function</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr.readyState <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">4</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>xhr.status <span class="token operator">&gt;=</span> <span class="token number">200</span> <span class="token operator">&amp;&amp;</span> xhr.status <span class="token operator">&lt;</span> <span class="token number">300</span> <span class="token operator">||</span> xhr.status <span class="token operator">==</span><span class="token operator">=</span> <span class="token number">304</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          console.log<span class="token punctuation">(</span>xhr.response<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    xhr.send<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><h3 id="_9-使用-http-proxy-middleware-实现跨域"><a href="#_9-使用-http-proxy-middleware-实现跨域" class="header-anchor">#</a> 9.使用 http-proxy-middleware 实现跨域</h3> <p>Node.js 中间件 http-proxy-middleware 实现跨域代理，原理大致与 nginx 相同，都是通过启一个代理服务器，实现数据的转发，也可以通过设置 cookieDomainRewrite 参数修改响应头中 cookie 中的域名，实现当前域的 cookie 写入，方便接口登录认证。</p> <p>非 vue 框架的跨域（2 次跨域）</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>-- 文件：index.html --<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>proxy 跨域<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
  <span class="token operator">&lt;</span>script<span class="token operator">&gt;</span>
    const xhr <span class="token operator">=</span> new XMLHttpRequest<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    // 前端开关：浏览器是否读写 cookie
    xhr.withCredentials <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span>

    // 访问 http-proxy-middleware 代理服务器
    xhr.open<span class="token punctuation">(</span><span class="token string">'get'</span>, <span class="token string">'http://www.proxy1.com:3000/login?user=admin'</span>, <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    xhr.send<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><p>中间代理服务中使用了 http-proxy-middleware 中间件，因此需要提前下载：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>$ <span class="token function">npm</span> <span class="token function">install</span> http-proxy-middleware --save-dev
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>/* 中间代理服务器 */
const express <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'express'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const proxy <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'http-proxy-middleware'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const app <span class="token operator">=</span> express<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

app.use<span class="token punctuation">(</span>
  <span class="token string">'/'</span>,
  proxy<span class="token punctuation">(</span><span class="token punctuation">{</span>
    // 代理跨域目标接口
    target: <span class="token string">'http://www.proxy2.com:8080'</span>,
    changeOrigin: true,

    // 修改响应头信息，实现跨域并允许带 cookie
    onProxyRes: <span class="token keyword">function</span> <span class="token punctuation">(</span>proxyRes, req, res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      res.header<span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Origin'</span>, <span class="token string">'http://www.proxy1.com'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      res.header<span class="token punctuation">(</span><span class="token string">'Access-Control-Allow-Credentials'</span>, <span class="token string">'true'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>,

    // 修改响应信息中的 cookie 域名
    cookieDomainRewrite: <span class="token string">'www.proxy1.com'</span> // 可以为 false，表示不修改
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">)</span><span class="token punctuation">;</span>

app.listen<span class="token punctuation">(</span><span class="token number">3000</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>/* 服务器 */
const http <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'http'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const qs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'querystring'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

const server <span class="token operator">=</span> http.createServer<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server.on<span class="token punctuation">(</span><span class="token string">'request'</span>, <span class="token keyword">function</span> <span class="token punctuation">(</span>req, res<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token builtin class-name">let</span> params <span class="token operator">=</span> qs.parse<span class="token punctuation">(</span>req.url.substring<span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">))</span><span class="token punctuation">;</span>

  // 向前台写 cookie
  res.writeHead<span class="token punctuation">(</span><span class="token number">200</span>, <span class="token punctuation">{</span>
    // HttpOnly：脚本无法读取
    <span class="token string">'Set-Cookie'</span><span class="token builtin class-name">:</span> <span class="token string">'l=a123456;Path=/;Domain=www.proxy2.com;HttpOnly'</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

  res.write<span class="token punctuation">(</span>JSON.stringify<span class="token punctuation">(</span>params<span class="token punctuation">))</span><span class="token punctuation">;</span>
  res.end<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

server.listen<span class="token punctuation">(</span><span class="token string">'8080'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>vue 框架的跨域（1 次跨域）</p> <p>利用 node + webpack + webpack-dev-server 代理接口跨域。在开发环境下，由于 Vue 渲染服务和接口代理服务都是 webpack-dev-server，所以页面与代理接口之间不再跨域，无须设置 Headers 跨域信息了。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>/* 导出服务器配置 */
module.exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  entry: <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  module: <span class="token punctuation">{</span><span class="token punctuation">}</span>,
  // <span class="token punctuation">..</span>.
  devServer: <span class="token punctuation">{</span>
    historyApiFallback: true,
    proxy: <span class="token punctuation">[</span><span class="token punctuation">{</span>
      context: <span class="token string">'/login'</span>,
      target: <span class="token string">'http://www.proxy2.com:8080'</span>,  // 代理跨域目标接口
      changeOrigin: true,
      secure: false,  // 当代理某些 https 服务报错时用
      cookieDomainRewrite: <span class="token string">'www.domain1.com'</span>  // 可以为 false，表示不修改
    <span class="token punctuation">}</span><span class="token punctuation">]</span>,
    noInfo: <span class="token boolean">true</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#同源策略" class="sidebar-link reco-side-同源策略" data-v-b57cc07c>同源策略</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#什么是跨域" class="sidebar-link reco-side-什么是跨域" data-v-b57cc07c>什么是跨域？</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#实现跨域的方式" class="sidebar-link reco-side-实现跨域的方式" data-v-b57cc07c>实现跨域的方式</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#_1-使用-jsonp-跨域" class="sidebar-link reco-side-_1-使用-jsonp-跨域" data-v-b57cc07c>1.使用 jsonp 跨域</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#_2-使用-cors-跨域" class="sidebar-link reco-side-_2-使用-cors-跨域" data-v-b57cc07c>2.使用 CORS 跨域</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#_3-使用-postmessage-实现跨域" class="sidebar-link reco-side-_3-使用-postmessage-实现跨域" data-v-b57cc07c>3.使用 postMessage 实现跨域</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#_4-使用-window-name-实现跨域" class="sidebar-link reco-side-_4-使用-window-name-实现跨域" data-v-b57cc07c>4.使用 window.name 实现跨域</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#_5-使用-location-hash-实现跨域" class="sidebar-link reco-side-_5-使用-location-hash-实现跨域" data-v-b57cc07c>5.使用 location.hash 实现跨域</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#_6-使用-document-domain-实现跨域" class="sidebar-link reco-side-_6-使用-document-domain-实现跨域" data-v-b57cc07c>6.使用 document.domain 实现跨域</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#_4-使用-websocket-实现跨域" class="sidebar-link reco-side-_4-使用-websocket-实现跨域" data-v-b57cc07c>4.使用 WebSocket 实现跨域</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#_8-使用-nginx-实现跨域" class="sidebar-link reco-side-_8-使用-nginx-实现跨域" data-v-b57cc07c>8.使用 nginx 实现跨域</a></li><li class="level-3" data-v-b57cc07c><a href="/vuepress-blog/blogs/cross-domain.html#_9-使用-http-proxy-middleware-实现跨域" class="sidebar-link reco-side-_9-使用-http-proxy-middleware-实现跨域" data-v-b57cc07c>9.使用 http-proxy-middleware 实现跨域</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="/media/starsky.m4a" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:20px;z-index:999999;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="/media/starsky.jpg" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(/media/starsky.jpg);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>Star Sky</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>Two Steps From Hell</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div></div></div>
    <script src="/vuepress-blog/assets/js/app.5d9f3e6e.js" defer></script><script src="/vuepress-blog/assets/js/7.52cd3cfd.js" defer></script><script src="/vuepress-blog/assets/js/2.5e77f0d2.js" defer></script><script src="/vuepress-blog/assets/js/1.c3e4b76d.js" defer></script><script src="/vuepress-blog/assets/js/60.d0b6fce9.js" defer></script>
  </body>
</html>
