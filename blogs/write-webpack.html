<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>手写webpack核心原理 | 张垒的博客</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="记录好的技术文档">
    
    <link rel="preload" href="/vuepress-blog/assets/css/0.styles.3d11a1f1.css" as="style"><link rel="preload" href="/vuepress-blog/assets/js/app.cfe4f1dc.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/7.a84a24ff.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/2.c3a99807.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/1.c178cf32.js" as="script"><link rel="preload" href="/vuepress-blog/assets/js/71.b1ddb05f.js" as="script"><link rel="prefetch" href="/vuepress-blog/assets/js/10.7e8e7b1e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/11.52366231.js"><link rel="prefetch" href="/vuepress-blog/assets/js/14.8efccace.js"><link rel="prefetch" href="/vuepress-blog/assets/js/15.acd8f527.js"><link rel="prefetch" href="/vuepress-blog/assets/js/16.696abc55.js"><link rel="prefetch" href="/vuepress-blog/assets/js/17.83830d6d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/18.02b980f1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/19.68f440c9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/20.0a9cda66.js"><link rel="prefetch" href="/vuepress-blog/assets/js/21.7edb07fe.js"><link rel="prefetch" href="/vuepress-blog/assets/js/22.f567e8c0.js"><link rel="prefetch" href="/vuepress-blog/assets/js/23.2884f722.js"><link rel="prefetch" href="/vuepress-blog/assets/js/24.d348a5d9.js"><link rel="prefetch" href="/vuepress-blog/assets/js/25.ec080050.js"><link rel="prefetch" href="/vuepress-blog/assets/js/26.69adbacd.js"><link rel="prefetch" href="/vuepress-blog/assets/js/27.e94edaee.js"><link rel="prefetch" href="/vuepress-blog/assets/js/28.fa2c3683.js"><link rel="prefetch" href="/vuepress-blog/assets/js/29.480e11e4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/3.83b8031d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/30.9e44a369.js"><link rel="prefetch" href="/vuepress-blog/assets/js/31.ab5be7a3.js"><link rel="prefetch" href="/vuepress-blog/assets/js/32.fd74f8d8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/33.cf91586c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/34.57e43fc1.js"><link rel="prefetch" href="/vuepress-blog/assets/js/35.f12bb5f8.js"><link rel="prefetch" href="/vuepress-blog/assets/js/36.0505d053.js"><link rel="prefetch" href="/vuepress-blog/assets/js/37.128579b6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/38.afd14854.js"><link rel="prefetch" href="/vuepress-blog/assets/js/39.136c8139.js"><link rel="prefetch" href="/vuepress-blog/assets/js/4.d9f667de.js"><link rel="prefetch" href="/vuepress-blog/assets/js/40.4702d49e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/41.c2c28470.js"><link rel="prefetch" href="/vuepress-blog/assets/js/42.2fc7c472.js"><link rel="prefetch" href="/vuepress-blog/assets/js/43.9b307549.js"><link rel="prefetch" href="/vuepress-blog/assets/js/44.ef443176.js"><link rel="prefetch" href="/vuepress-blog/assets/js/45.a7c60c22.js"><link rel="prefetch" href="/vuepress-blog/assets/js/46.466967ef.js"><link rel="prefetch" href="/vuepress-blog/assets/js/47.48816b2e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/48.cbbfa44c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/49.b362bf6d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/5.3df9e6ac.js"><link rel="prefetch" href="/vuepress-blog/assets/js/50.7605d1cc.js"><link rel="prefetch" href="/vuepress-blog/assets/js/51.35192135.js"><link rel="prefetch" href="/vuepress-blog/assets/js/52.bf567756.js"><link rel="prefetch" href="/vuepress-blog/assets/js/53.b0768c7b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/54.9735e1f7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/55.84021d4c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/56.e4771e7e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/57.7c72619d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/58.f8487d5b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/59.c97f0f0e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/6.5940db39.js"><link rel="prefetch" href="/vuepress-blog/assets/js/60.0cb291f7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/61.2405fff4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/62.a854dc11.js"><link rel="prefetch" href="/vuepress-blog/assets/js/63.13eb262f.js"><link rel="prefetch" href="/vuepress-blog/assets/js/64.cb4d6ac7.js"><link rel="prefetch" href="/vuepress-blog/assets/js/65.6e7515c4.js"><link rel="prefetch" href="/vuepress-blog/assets/js/66.7db29015.js"><link rel="prefetch" href="/vuepress-blog/assets/js/67.45bf8f7c.js"><link rel="prefetch" href="/vuepress-blog/assets/js/68.b604b4f6.js"><link rel="prefetch" href="/vuepress-blog/assets/js/69.8e28194e.js"><link rel="prefetch" href="/vuepress-blog/assets/js/70.6c3a479b.js"><link rel="prefetch" href="/vuepress-blog/assets/js/8.f2a8d12d.js"><link rel="prefetch" href="/vuepress-blog/assets/js/9.0b4a9f34.js"><link rel="prefetch" href="/vuepress-blog/assets/js/vendors~docsearch.5bf76089.js">
    <link rel="stylesheet" href="/vuepress-blog/assets/css/0.styles.3d11a1f1.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container no-sidebar" data-v-7dd95ae2><div data-v-7dd95ae2><div class="password-shadow password-wrapper-out" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>张垒的博客</h3> <p class="description" data-v-59e6cb88>记录好的技术文档</p> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div class="hide" data-v-7dd95ae2><header class="navbar" data-v-7dd95ae2><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/vuepress-blog/" class="home-link router-link-active"><!----> <span class="site-name">张垒的博客</span></a> <div class="links"><div class="color-picker"><a class="color-button"><i class="iconfont reco-color"></i></a> <div class="color-picker-menu" style="display:none;"><div class="mode-options"><h4 class="title">Choose mode</h4> <ul class="color-mode-options"><li class="dark">dark</li><li class="auto active">auto</li><li class="light">light</li></ul></div></div></div> <div class="search-box"><i class="iconfont reco-search"></i> <input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/刷题/" class="nav-link"><i class="undefined"></i>
  刷题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      zhang lei 的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/4495277269197975" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/zerle" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/vuepress-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav></div></header> <div class="sidebar-mask" data-v-7dd95ae2></div> <aside class="sidebar" data-v-7dd95ae2><div class="personal-info-wrapper" data-v-1fad0c41 data-v-7dd95ae2><img src="/vuepress-blog/me.jpg" alt="author-avatar" class="personal-img" data-v-1fad0c41> <!----> <div class="num" data-v-1fad0c41><div data-v-1fad0c41><h3 data-v-1fad0c41>33</h3> <h6 data-v-1fad0c41>文章</h6></div> <div data-v-1fad0c41><h3 data-v-1fad0c41>31</h3> <h6 data-v-1fad0c41>标签</h6></div></div> <ul class="social-links" data-v-1fad0c41></ul> <hr data-v-1fad0c41></div> <nav class="nav-links"><div class="nav-item"><a href="/vuepress-blog/" class="nav-link"><i class="undefined"></i>
  首页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="iconfont reco-category"></i>
      博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/前端/" class="nav-link"><i class="undefined"></i>
  前端
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/工具/" class="nav-link"><i class="undefined"></i>
  工具
</a></li><li class="dropdown-item"><!----> <a href="/vuepress-blog/categories/刷题/" class="nav-link"><i class="undefined"></i>
  刷题
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><a class="dropdown-title"><span class="title"><i class="undefined"></i>
      zhang lei 的博客
    </span> <span class="arrow right"></span></a> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="https://juejin.cn/user/4495277269197975" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  掘金
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li><li class="dropdown-item"><!----> <a href="https://github.com/zerle" target="_blank" rel="noopener noreferrer" class="nav-link external"><i class="undefined"></i>
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></li></ul></div></div><div class="nav-item"><a href="/vuepress-blog/tag/" class="nav-link"><i class="iconfont reco-tag"></i>
  Tag
</a></div> <!----></nav> <!----> </aside> <div class="password-shadow password-wrapper-in" style="display:none;" data-v-59e6cb88 data-v-7dd95ae2><h3 class="title" data-v-59e6cb88>手写webpack核心原理</h3> <!----> <label id="box" class="inputBox" data-v-59e6cb88><input type="password" value="" data-v-59e6cb88> <span data-v-59e6cb88>Konck! Knock!</span> <button data-v-59e6cb88>OK</button></label> <div class="footer" data-v-59e6cb88><span data-v-59e6cb88><i class="iconfont reco-theme" data-v-59e6cb88></i> <a target="blank" href="https://vuepress-theme-reco.recoluan.com" data-v-59e6cb88>vuePress-theme-reco</a></span> <span data-v-59e6cb88><i class="iconfont reco-copyright" data-v-59e6cb88></i> <a data-v-59e6cb88><!---->
          
        <!---->
        2023
      </a></span></div></div> <div data-v-7dd95ae2><div data-v-7dd95ae2><main class="page"><section style="display:;"><div class="page-title"><h1 class="title">手写webpack核心原理</h1> <div data-v-8a445198><!----> <i class="iconfont reco-date" data-v-8a445198><span data-v-8a445198>2020/8/24</span></i> <!----> <i class="tags iconfont reco-tag" data-v-8a445198><span class="tag-item" data-v-8a445198>Webpack</span></i></div></div> <div class="theme-reco-content content__default"><p>手写webpack核心原理，再也不怕面试官问我webpack原理</p> <h2 id="手写webpack核心原理"><a href="#手写webpack核心原理" class="header-anchor">#</a> 手写webpack核心原理</h2> <p>一、核心打包原理
1.1 打包的主要流程如下
1.2 具体细节
二、基本准备工作
三、获取模块内容
四、分析模块
五、收集依赖
六、ES6转成ES5（AST）
七、递归获取所有依赖
八、处理两个关键字</p> <h2 id="一、核心打包原理"><a href="#一、核心打包原理" class="header-anchor">#</a> 一、核心打包原理</h2> <p>1.1 打包的主要流程如下</p> <p>1.需要读到入口文件里面的内容。
2.分析入口文件，递归的去读取模块所依赖的文件内容，生成AST语法树。
3.根据AST语法树，生成浏览器能够运行的代码
1.2 具体细节</p> <p>1.获取主模块内容
2.分析模块
安装@babel/parser包（转AST）
3.对模块内容进行处理
安装@babel/traverse包（遍历AST收集依赖）
安装@babel/core和@babel/preset-env包   （es6转ES5）
4.递归所有模块
5.生成最终代码</p> <h2 id="二、基本准备工作"><a href="#二、基本准备工作" class="header-anchor">#</a> 二、基本准备工作</h2> <p>我们先建一个项目</p> <p>项目目录暂时如下：</p> <p>{% asset_img 01.png This is an image %}</p> <p>项目地址：https://github.com/zerle/Webpack-part</p> <p>我们创建了add.js文件和minus.js文件,然后 在index.js中引入，再将index.js文件引入index.html。</p> <p>代码如下:</p> <p>add.js</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> default <span class="token punctuation">(</span>a,b<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
  <span class="token builtin class-name">return</span> a+b<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>minus.js</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token builtin class-name">export</span> const minus <span class="token operator">=</span> <span class="token punctuation">(</span>a,b<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    <span class="token builtin class-name">return</span> a-b
<span class="token punctuation">}</span>
</code></pre></div><p>index.js</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">import</span> <span class="token function">add</span> from <span class="token string">&quot;./add.js&quot;</span>
<span class="token function">import</span> <span class="token punctuation">{</span>minus<span class="token punctuation">}</span> from <span class="token string">&quot;./minus.js&quot;</span><span class="token punctuation">;</span>

const <span class="token function">sum</span> <span class="token operator">=</span> add<span class="token punctuation">(</span><span class="token number">1,2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const division <span class="token operator">=</span> minus<span class="token punctuation">(</span><span class="token number">2,1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console.log<span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
console.log<span class="token punctuation">(</span>division<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>index.html</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token operator">&lt;</span><span class="token operator">!</span>DOCTYPE html<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>html <span class="token assign-left variable">lang</span><span class="token operator">=</span><span class="token string">&quot;en&quot;</span><span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>head<span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>meta <span class="token assign-left variable">charset</span><span class="token operator">=</span><span class="token string">&quot;UTF-8&quot;</span><span class="token operator">&gt;</span>
    <span class="token operator">&lt;</span>title<span class="token operator">&gt;</span>Title<span class="token operator">&lt;</span>/title<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/head<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>script <span class="token assign-left variable">src</span><span class="token operator">=</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token operator">&gt;</span><span class="token operator">&lt;</span>/script<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/body<span class="token operator">&gt;</span>
<span class="token operator">&lt;</span>/html<span class="token operator">&gt;</span>
</code></pre></div><p>现在我们打开index.html。你猜会发生什么？？？显然会报错，因为浏览器还不能识别import等ES6语法</p> <p>{% asset_img 02.png This is an image %}</p> <p>不过没关系，因为我们本来就是要来解决这些问题的。</p> <h2 id="三、获取模块内容"><a href="#三、获取模块内容" class="header-anchor">#</a> 三、获取模块内容</h2> <p>好了，现在我们开始根据上面核心打包原理的思路来实践一下，第一步就是 实现获取主模块内容。</p> <p>我们来创建一个bundle.js文件。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// 获取主入口文件
const fs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
const getModuleInfo <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const body <span class="token operator">=</span> fs.readFileSync<span class="token punctuation">(</span>file,<span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    console.log<span class="token punctuation">(</span>body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
getModuleInfo<span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>目前项目目录如下</p> <p>{% asset_img 03.png This is an image %}</p> <p>我们来执行一下bundle.js，看看是否成功获得入口文件内容</p> <p>{% asset_img 04.png This is an image %}</p> <p>哇塞，不出所料的成功。一切尽在掌握之中。好了，已经实现第一步了，且让我看看第二步是要干嘛。</p> <p>哦？是分析模块了</p> <h2 id="四、分析模块"><a href="#四、分析模块" class="header-anchor">#</a> 四、分析模块</h2> <p>分析模块的主要任务是 将获取到的模块内容 解析成AST语法树，这个需要用到一个依赖包@babel/parser</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> @babel/parser
</code></pre></div><p>ok,安装完成我们将@babel/parser引入bundle.js,</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// 获取主入口文件
const fs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
const parser <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
const getModuleInfo <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const body <span class="token operator">=</span> fs.readFileSync<span class="token punctuation">(</span>file,<span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    // 新增代码
    const ast <span class="token operator">=</span> parser.parse<span class="token punctuation">(</span>body,<span class="token punctuation">{</span>
        sourceType:<span class="token string">'module'</span> //表示我们要解析的是ES模块
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console.log<span class="token punctuation">(</span>ast<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
getModuleInfo<span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>我们暂时用到的是sourceType，也就是用来指明我们要解析的代码是什么模块。</p> <p>好了，现在我们来执行一下 bundle.js，看看AST是否成功生成。</p> <p>{% asset_img 05.png This is an image %}</p> <p>成功。又是不出所料的成功。</p> <p>不过，我们需要知道的是，当前我们解析出来的不单单是index.js文件里的内容，它也包括了文件的其他信息。 而它的内容其实是它的属性program里的body里。如图所示</p> <p>{% asset_img 06.png This is an image %}</p> <p>我们可以改成打印ast.program.body看看</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// 获取主入口文件
const fs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
const parser <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
const getModuleInfo <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const body <span class="token operator">=</span> fs.readFileSync<span class="token punctuation">(</span>file,<span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    const ast <span class="token operator">=</span> parser.parse<span class="token punctuation">(</span>body,<span class="token punctuation">{</span>
        sourceType:<span class="token string">'module'</span> //表示我们要解析的是ES模块
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    console.log<span class="token punctuation">(</span>ast.program.body<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
getModuleInfo<span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span>
</code></pre></div><p>执行</p> <p>{% asset_img 07.png This is an image %}</p> <p>看，现在打印出来的就是 index.js文件里的内容（也就是我们再index.js里写的代码啦）.</p> <h2 id="五、收集依赖"><a href="#五、收集依赖" class="header-anchor">#</a> 五、收集依赖</h2> <p>现在我们需要 遍历AST，将用到的依赖收集起来。什么意思呢？其实就是将用import语句引入的文件路径收集起来。我们将收集起来的路径放到deps里。</p> <p>前面我们提到过，遍历AST要用到@babel/traverse依赖包</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> @babel/traverse
</code></pre></div><p>现在，我们引入。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>const fs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
const path <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
const parser <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
const traverse <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span>.default
const getModuleInfo <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const body <span class="token operator">=</span> fs.readFileSync<span class="token punctuation">(</span>file,<span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    const ast <span class="token operator">=</span> parser.parse<span class="token punctuation">(</span>body,<span class="token punctuation">{</span>
        sourceType:<span class="token string">'module'</span> //表示我们要解析的是ES模块
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    
    // 新增代码
    const deps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    traverse<span class="token punctuation">(</span>ast,<span class="token punctuation">{</span>
        ImportDeclaration<span class="token punctuation">(</span><span class="token punctuation">{</span>node<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            const <span class="token function">dirname</span> <span class="token operator">=</span> path.dirname<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            const abspath <span class="token operator">=</span> <span class="token string">'./'</span> + path.join<span class="token punctuation">(</span>dirname,node.source.value<span class="token punctuation">)</span>
            deps<span class="token punctuation">[</span>node.source.value<span class="token punctuation">]</span> <span class="token operator">=</span> abspath
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console.log<span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">;</span>


<span class="token punctuation">}</span>
getModuleInfo<span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>配置对象里，我们配置了ImportDeclaration方法，这是什么意思呢？ 我们看看之前打印出来的AST。</p> <p>{% asset_img 08.png This is an image %}</p> <p>ImportDeclaration方法代表的是对type类型为ImportDeclaration的节点的处理。
这里我们获得了该节点中source的value，也就是node.source.value，
这里的value指的是什么意思呢？其实就是import的值，可以看我们的index.js的代码。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">import</span> <span class="token function">add</span> from <span class="token string">&quot;./add.js&quot;</span>
<span class="token function">import</span> <span class="token punctuation">{</span>minus<span class="token punctuation">}</span> from <span class="token string">&quot;./minus.js&quot;</span><span class="token punctuation">;</span>

const <span class="token function">sum</span> <span class="token operator">=</span> add<span class="token punctuation">(</span><span class="token number">1,2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
const division <span class="token operator">=</span> minus<span class="token punctuation">(</span><span class="token number">2,1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

console.log<span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span>
console.log<span class="token punctuation">(</span>division<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可见，value指的就是import后面的 './add.js' 和 './minus.js'</p> <p>然后我们将file目录路径跟获得的value值拼接起来保存到deps里，美其名曰：收集依赖。</p> <p>ok，这个操作就结束了，执行看看收集成功了没？</p> <p>{% asset_img 09.png This is an image %}</p> <p>oh my god。又成功了。</p> <h2 id="六、es6转成es5-ast"><a href="#六、es6转成es5-ast" class="header-anchor">#</a> 六、ES6转成ES5（AST）</h2> <p>现在我们需要把获得的ES6的AST转化成ES5，前面讲到过，执行这一步需要两个依赖包</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token function">npm</span> <span class="token function">install</span> @babel/core @babel/preset-env
</code></pre></div><p>我们现在将依赖引入并使用</p> <div class="language-bash extra-class"><pre class="language-bash"><code>const fs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
const path <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
const parser <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
const traverse <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span>.default
const babel <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span>
const getModuleInfo <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const body <span class="token operator">=</span> fs.readFileSync<span class="token punctuation">(</span>file,<span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    const ast <span class="token operator">=</span> parser.parse<span class="token punctuation">(</span>body,<span class="token punctuation">{</span>
        sourceType:<span class="token string">'module'</span> //表示我们要解析的是ES模块
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    const deps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    traverse<span class="token punctuation">(</span>ast,<span class="token punctuation">{</span>
        ImportDeclaration<span class="token punctuation">(</span><span class="token punctuation">{</span>node<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            const <span class="token function">dirname</span> <span class="token operator">=</span> path.dirname<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            const abspath <span class="token operator">=</span> <span class="token string">&quot;./&quot;</span> + path.join<span class="token punctuation">(</span>dirname,node.source.value<span class="token punctuation">)</span>
            deps<span class="token punctuation">[</span>node.source.value<span class="token punctuation">]</span> <span class="token operator">=</span> abspath
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    
    新增代码
    const <span class="token punctuation">{</span>code<span class="token punctuation">}</span> <span class="token operator">=</span> babel.transformFromAst<span class="token punctuation">(</span>ast,null,<span class="token punctuation">{</span>
        presets:<span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console.log<span class="token punctuation">(</span>code<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token punctuation">}</span>
getModuleInfo<span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>简单说一下，其实就是将我们传入的AST转化成我们在第三个参数里配置的模块类型。</p> <p>好了，现在我们来执行一下，看看结果</p> <p>{% asset_img 10.png This is an image %}</p> <p>我的天，一如既往的成功。可见 它将我们写const 转化成var了。</p> <p>好了，这一步到此结束，咦，你可能会有疑问，上一步的收集依赖在这里怎么没啥关系啊，确实如此。收集依赖是为了下面进行的递归操作。</p> <h2 id="七、递归获取所有依赖"><a href="#七、递归获取所有依赖" class="header-anchor">#</a> 七、递归获取所有依赖</h2> <p>经过上面的过程，现在我们知道getModuleInfo是用来获取一个模块的内容，不过我们还没把获取的内容return出来，因此，更改下getModuleInfo方法</p> <div class="language-bash extra-class"><pre class="language-bash"><code>const getModuleInfo <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const body <span class="token operator">=</span> fs.readFileSync<span class="token punctuation">(</span>file,<span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    const ast <span class="token operator">=</span> parser.parse<span class="token punctuation">(</span>body,<span class="token punctuation">{</span>
        sourceType:<span class="token string">'module'</span> //表示我们要解析的是ES模块
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    const deps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    traverse<span class="token punctuation">(</span>ast,<span class="token punctuation">{</span>
        ImportDeclaration<span class="token punctuation">(</span><span class="token punctuation">{</span>node<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            const <span class="token function">dirname</span> <span class="token operator">=</span> path.dirname<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            const abspath <span class="token operator">=</span> <span class="token string">&quot;./&quot;</span> + path.join<span class="token punctuation">(</span>dirname,node.source.value<span class="token punctuation">)</span>
            deps<span class="token punctuation">[</span>node.source.value<span class="token punctuation">]</span> <span class="token operator">=</span> abspath
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    const <span class="token punctuation">{</span>code<span class="token punctuation">}</span> <span class="token operator">=</span> babel.transformFromAst<span class="token punctuation">(</span>ast,null,<span class="token punctuation">{</span>
        presets:<span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    // 新增代码
    const moduleInfo <span class="token operator">=</span> <span class="token punctuation">{</span>file,deps,code<span class="token punctuation">}</span>
    <span class="token builtin class-name">return</span> moduleInfo
<span class="token punctuation">}</span>
</code></pre></div><p>我们返回了一个对象 ，这个对象包括该模块的路径（file），该模块的依赖（deps），该模块转化成es5的代码
该方法只能获取一个模块的的信息，但是我们要怎么获取一个模块里面的依赖模块的信息呢？
没错，看标题，，你应该想到了就算递归。
现在我们来写一个递归方法，递归获取依赖</p> <div class="language-bash extra-class"><pre class="language-bash"><code>const parseModules <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const entry <span class="token operator">=</span>  getModuleInfo<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    const temp <span class="token operator">=</span> <span class="token punctuation">[</span>entry<span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>let i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>temp.length<span class="token punctuation">;</span>i++<span class="token punctuation">)</span><span class="token punctuation">{</span>
        const deps <span class="token operator">=</span> temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>.deps
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>const key <span class="token keyword">in</span> deps<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deps.hasOwnProperty<span class="token punctuation">(</span>key<span class="token punctuation">))</span><span class="token punctuation">{</span>
                    temp.push<span class="token punctuation">(</span>getModuleInfo<span class="token punctuation">(</span>deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">))</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    console.log<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><p>讲解下parseModules方法：</p> <p>1.我们首先传入主模块路径
2.将获得的模块信息放到temp数组里。
3.外面的循坏遍历temp数组，此时的temp数组只有主模块
4.循环里面再获得主模块的依赖deps
5.遍历deps，通过调用getModuleInfo将获得的依赖模块信息push到temp数组里。
目前bundle.js文件：</p> <div class="language-bash extra-class"><pre class="language-bash"><code>const fs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
const path <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
const parser <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
const traverse <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span>.default
const babel <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span>
const getModuleInfo <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const body <span class="token operator">=</span> fs.readFileSync<span class="token punctuation">(</span>file,<span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    const ast <span class="token operator">=</span> parser.parse<span class="token punctuation">(</span>body,<span class="token punctuation">{</span>
        sourceType:<span class="token string">'module'</span> //表示我们要解析的是ES模块
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    const deps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    traverse<span class="token punctuation">(</span>ast,<span class="token punctuation">{</span>
        ImportDeclaration<span class="token punctuation">(</span><span class="token punctuation">{</span>node<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            const <span class="token function">dirname</span> <span class="token operator">=</span> path.dirname<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            const abspath <span class="token operator">=</span> <span class="token string">&quot;./&quot;</span> + path.join<span class="token punctuation">(</span>dirname,node.source.value<span class="token punctuation">)</span>
            deps<span class="token punctuation">[</span>node.source.value<span class="token punctuation">]</span> <span class="token operator">=</span> abspath
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    const <span class="token punctuation">{</span>code<span class="token punctuation">}</span> <span class="token operator">=</span> babel.transformFromAst<span class="token punctuation">(</span>ast,null,<span class="token punctuation">{</span>
        presets:<span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    const moduleInfo <span class="token operator">=</span> <span class="token punctuation">{</span>file,deps,code<span class="token punctuation">}</span>
    <span class="token builtin class-name">return</span> moduleInfo
<span class="token punctuation">}</span>

// 新增代码
const parseModules <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const entry <span class="token operator">=</span>  getModuleInfo<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    const temp <span class="token operator">=</span> <span class="token punctuation">[</span>entry<span class="token punctuation">]</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>let i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>temp.length<span class="token punctuation">;</span>i++<span class="token punctuation">)</span><span class="token punctuation">{</span>
        const deps <span class="token operator">=</span> temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>.deps
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>const key <span class="token keyword">in</span> deps<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deps.hasOwnProperty<span class="token punctuation">(</span>key<span class="token punctuation">))</span><span class="token punctuation">{</span>
                    temp.push<span class="token punctuation">(</span>getModuleInfo<span class="token punctuation">(</span>deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">))</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    console.log<span class="token punctuation">(</span>temp<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
parseModules<span class="token punctuation">(</span><span class="token string">&quot;./src/index.js&quot;</span><span class="token punctuation">)</span>
</code></pre></div><p>按照目前我们的项目来说执行完，应当是temp 应当是存放了index.js,add.js,minus.js三个模块。 ,执行看看。</p> <p>{% asset_img 11.png This is an image %}</p> <p>牛逼！！！确实如此。</p> <p>不过现在的temp数组里的对象格式不利于后面的操作，我们希望是以文件的路径为key，{code，deps}为值的形式存储。因此，我们创建一个新的对象depsGraph。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>onst parseModules <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const entry <span class="token operator">=</span>  getModuleInfo<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    const temp <span class="token operator">=</span> <span class="token punctuation">[</span>entry<span class="token punctuation">]</span> 
    const depsGraph <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span> //新增代码
    <span class="token keyword">for</span> <span class="token punctuation">(</span>let i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>temp.length<span class="token punctuation">;</span>i++<span class="token punctuation">)</span><span class="token punctuation">{</span>
        const deps <span class="token operator">=</span> temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>.deps
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>const key <span class="token keyword">in</span> deps<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deps.hasOwnProperty<span class="token punctuation">(</span>key<span class="token punctuation">))</span><span class="token punctuation">{</span>
                    temp.push<span class="token punctuation">(</span>getModuleInfo<span class="token punctuation">(</span>deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">))</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    // 新增代码
    temp.forEach<span class="token punctuation">(</span>moduleInfo<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
        depsGraph<span class="token punctuation">[</span>moduleInfo.file<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            deps:moduleInfo.deps,
            code:moduleInfo.code
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console.log<span class="token punctuation">(</span>depsGraph<span class="token punctuation">)</span>
    <span class="token builtin class-name">return</span> depsGraph
<span class="token punctuation">}</span>
</code></pre></div><p>ok，现在存储的就是这种格式啦</p> <p>{% asset_img 12.png This is an image %}</p> <h2 id="八、处理两个关键字"><a href="#八、处理两个关键字" class="header-anchor">#</a> 八、处理两个关键字</h2> <p>我们现在的目的就是要生成一个bundle.js文件，也就是打包后的一个文件。其实思路很简单，就是把index.js的内容和它的依赖模块整合起来。然后把代码写到一个新建的js文件。</p> <p>{% asset_img 13.png This is an image %}</p> <p>我们把这段代码格式化一下</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// index.js
<span class="token string">&quot;use strict&quot;</span>
var _add <span class="token operator">=</span> _interopRequireDefault<span class="token punctuation">(</span>require<span class="token punctuation">(</span><span class="token string">&quot;./add.js&quot;</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
var _minus <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">&quot;./minus.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> _interopRequireDefault<span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token builtin class-name">return</span> obj <span class="token operator">&amp;&amp;</span> obj.__esModule ? obj <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;default&quot;</span><span class="token builtin class-name">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
var <span class="token function">sum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span>, _add<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var division <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span>, _minus.minus<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console.log<span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span> console.log<span class="token punctuation">(</span>division<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><div class="language-bash extra-class"><pre class="language-bash"><code>// add.js
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
Object.defineProperty<span class="token punctuation">(</span>exports, <span class="token string">&quot;__esModule&quot;</span>, <span class="token punctuation">{</span>  value: true<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> void <span class="token number">0</span><span class="token punctuation">;</span>
var _default <span class="token operator">=</span> <span class="token keyword">function</span> _default<span class="token punctuation">(</span>a, b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token builtin class-name">return</span> a + b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
exports<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> _default<span class="token punctuation">;</span>
</code></pre></div><p>但是我们现在是不能执行index.js这段代码的，因为浏览器不会识别执行require和exports。</p> <p>不能识别是为什么？不就是因为没有定义这require函数，和exports对象。那我们可以自己定义。</p> <p>我们创建一个函数</p> <div class="language-bash extra-class"><pre class="language-bash"><code>const bundle <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const depsGraph <span class="token operator">=</span> JSON.stringify<span class="token punctuation">(</span>parseModules<span class="token punctuation">(</span>file<span class="token punctuation">))</span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>我们将上一步获得的depsGraph保存起来。</p> <p>现在返回一个整合完整的字符串代码。</p> <p>怎么返回呢？更改下bundle函数</p> <div class="language-bash extra-class"><pre class="language-bash"><code>const bundle <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const depsGraph <span class="token operator">=</span> JSON.stringify<span class="token punctuation">(</span>parseModules<span class="token punctuation">(</span>file<span class="token punctuation">))</span>
    <span class="token builtin class-name">return</span> <span class="token variable"><span class="token variable">`</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">function</span> require<span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token punctuation">(</span>function <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        eval<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
                    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>graph<span class="token punctuation">[</span>file<span class="token punctuation">]</span>.code<span class="token punctuation">)</span>
                <span class="token punctuation">}</span>
                require<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>depsGraph<span class="token punctuation">)</span><span class="token variable">`</span></span>
    
<span class="token punctuation">}</span>
</code></pre></div><p>我们看下返回的这段代码</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">(</span>function <span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> require<span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token punctuation">(</span>function <span class="token punctuation">(</span>code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eval<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>graph<span class="token punctuation">[</span>file<span class="token punctuation">]</span>.code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    require<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>depsGraph<span class="token punctuation">)</span>
</code></pre></div><p>其实就是</p> <p>1.把保存下来的depsGraph，传入一个立即执行函数。
2.将主模块路径传入require函数
3.执行执行reuire函数的时候，又立即执行一个立即执行函数，这里是把code的值传进去了
4.执行eval（code）。也就是执行主模块的code这段代码</p> <p>我们再来看下code的值</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// index.js
<span class="token string">&quot;use strict&quot;</span>
var _add <span class="token operator">=</span> _interopRequireDefault<span class="token punctuation">(</span>require<span class="token punctuation">(</span><span class="token string">&quot;./add.js&quot;</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
var _minus <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">&quot;./minus.js&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">function</span> _interopRequireDefault<span class="token punctuation">(</span>obj<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token builtin class-name">return</span> obj <span class="token operator">&amp;&amp;</span> obj.__esModule ? obj <span class="token builtin class-name">:</span> <span class="token punctuation">{</span> <span class="token string">&quot;default&quot;</span><span class="token builtin class-name">:</span> obj <span class="token punctuation">}</span><span class="token punctuation">;</span> <span class="token punctuation">}</span>
var <span class="token function">sum</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span>, _add<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">1</span>, <span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
var division <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token number">0</span>, _minus.minus<span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token number">2</span>, <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
console.log<span class="token punctuation">(</span>sum<span class="token punctuation">)</span><span class="token punctuation">;</span> console.log<span class="token punctuation">(</span>division<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>没错执行这段代码的时候，又会用到require函数。此时require的参数为add.js的路径，哎，不是绝对路径，需要转化成绝对路径。因此写一个函数absRequire来转化。怎么实现呢？我们来看下代码</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">(</span>function <span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> require<span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">function</span> absRequire<span class="token punctuation">(</span>relPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin class-name">return</span> require<span class="token punctuation">(</span>graph<span class="token punctuation">[</span>file<span class="token punctuation">]</span>.deps<span class="token punctuation">[</span>relPath<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token punctuation">(</span>function <span class="token punctuation">(</span>require,code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eval<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>absRequire,graph<span class="token punctuation">[</span>file<span class="token punctuation">]</span>.code<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    require<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>depsGraph<span class="token punctuation">)</span>

</code></pre></div><p>实际上是实现了一层拦截。</p> <p>1.执行require（'./src/index.js'）函数
2.执行了</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">(</span>function <span class="token punctuation">(</span>require,code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    eval<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>absRequire,graph<span class="token punctuation">[</span>file<span class="token punctuation">]</span>.code<span class="token punctuation">)</span>
</code></pre></div><p>3.执行eval，也就是执行了index.js的代码。
4.执行过程会执行到require函数。
5.这时会调用这个require，也就是我们传入的absRequire</p> <p>{% asset_img 14.png This is an image %}</p> <p>6.而执行absRequire就执行了return require(graph[file].deps[relPath])这段代码，也就是执行了外面这require</p> <p>{% asset_img 15.png This is an image %}</p> <p>在这里return require(graph[file].deps[relPath])，我们已经对路径转化成绝对路径了。因此执行外面的require的时候就是传入绝对路径。</p> <p>7.而执行require（&quot;./src/add.js&quot;）之后，又会执行eval，也就是执行add.js文件的代码。
是不是有点绕？其实是个递归。
这样就将代码整合起来了，但是有个问题，就是在执行add.js的code时候，会遇到exports这个还没定义的问题。如下所示</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// add.js
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
Object.defineProperty<span class="token punctuation">(</span>exports, <span class="token string">&quot;__esModule&quot;</span>, <span class="token punctuation">{</span>  value: true<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> void <span class="token number">0</span><span class="token punctuation">;</span>
var _default <span class="token operator">=</span> <span class="token keyword">function</span> _default<span class="token punctuation">(</span>a, b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token builtin class-name">return</span> a + b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
exports<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> _default<span class="token punctuation">;</span>
</code></pre></div><p>我们发现 这里它把exports当作一个对象来使用了，但是这个对象还没定义，因此我们可以自己定义一个exports对象。</p> <div class="language-bash extra-class"><pre class="language-bash"><code><span class="token punctuation">(</span>function <span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">function</span> require<span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">function</span> absRequire<span class="token punctuation">(</span>relPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token builtin class-name">return</span> require<span class="token punctuation">(</span>graph<span class="token punctuation">[</span>file<span class="token punctuation">]</span>.deps<span class="token punctuation">[</span>relPath<span class="token punctuation">]</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        var exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
        <span class="token punctuation">(</span>function <span class="token punctuation">(</span>require,exports,code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            eval<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>absRequire,exports,graph<span class="token punctuation">[</span>file<span class="token punctuation">]</span>.code<span class="token punctuation">)</span>
        <span class="token builtin class-name">return</span> exports
    <span class="token punctuation">}</span>
    require<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>depsGraph<span class="token punctuation">)</span>
</code></pre></div><p>我们增添了一个空对象 exports，执行add.js代码的时候，会往这个空对象上增加一些属性，</p> <div class="language-bash extra-class"><pre class="language-bash"><code>// add.js
<span class="token string">&quot;use strict&quot;</span><span class="token punctuation">;</span>
Object.defineProperty<span class="token punctuation">(</span>exports, <span class="token string">&quot;__esModule&quot;</span>, <span class="token punctuation">{</span>  value: true<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
exports<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> void <span class="token number">0</span><span class="token punctuation">;</span>
var _default <span class="token operator">=</span> <span class="token keyword">function</span> _default<span class="token punctuation">(</span>a, b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token builtin class-name">return</span> a + b<span class="token punctuation">;</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
exports<span class="token punctuation">[</span><span class="token string">&quot;default&quot;</span><span class="token punctuation">]</span> <span class="token operator">=</span> _default<span class="token punctuation">;</span>
</code></pre></div><p>比如，执行完这段代码后</p> <div class="language-bash extra-class"><pre class="language-bash"><code>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
  __esModule：<span class="token punctuation">{</span>  value: true<span class="token punctuation">}</span>，
  default：function _default<span class="token punctuation">(</span>a, b<span class="token punctuation">)</span> <span class="token punctuation">{</span>  <span class="token builtin class-name">return</span> a + b<span class="token punctuation">;</span><span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>然后我们把exports对象return出去。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>var _add <span class="token operator">=</span> _interopRequireDefault<span class="token punctuation">(</span>require<span class="token punctuation">(</span><span class="token string">&quot;./add.js&quot;</span><span class="token punctuation">))</span><span class="token punctuation">;</span>
</code></pre></div><p>可见，return出去的值，被_interopRequireDefault接收，_interopRequireDefault再返回default这个属性给_add，因此_add = function _default(a, b) { return a + b;}
现在明白了，为什么ES6模块 引入的是一个对象引用了吧，因为exports就是一个对象。
至此，处理；两个关键词的功能就完整了。</p> <div class="language-bash extra-class"><pre class="language-bash"><code>const fs <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span>
const path <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span>
const parser <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/parser'</span><span class="token punctuation">)</span>
const traverse <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/traverse'</span><span class="token punctuation">)</span>.default
const babel <span class="token operator">=</span> require<span class="token punctuation">(</span><span class="token string">'@babel/core'</span><span class="token punctuation">)</span>
const getModuleInfo <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span><span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const body <span class="token operator">=</span> fs.readFileSync<span class="token punctuation">(</span>file,<span class="token string">'utf-8'</span><span class="token punctuation">)</span>
    const ast <span class="token operator">=</span> parser.parse<span class="token punctuation">(</span>body,<span class="token punctuation">{</span>
        sourceType:<span class="token string">'module'</span> //表示我们要解析的是ES模块
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    const deps <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    traverse<span class="token punctuation">(</span>ast,<span class="token punctuation">{</span>
        ImportDeclaration<span class="token punctuation">(</span><span class="token punctuation">{</span>node<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
            const <span class="token function">dirname</span> <span class="token operator">=</span> path.dirname<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
            const abspath <span class="token operator">=</span> <span class="token string">&quot;./&quot;</span> + path.join<span class="token punctuation">(</span>dirname,node.source.value<span class="token punctuation">)</span>
            deps<span class="token punctuation">[</span>node.source.value<span class="token punctuation">]</span> <span class="token operator">=</span> abspath
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    const <span class="token punctuation">{</span>code<span class="token punctuation">}</span> <span class="token operator">=</span> babel.transformFromAst<span class="token punctuation">(</span>ast,null,<span class="token punctuation">{</span>
        presets:<span class="token punctuation">[</span><span class="token string">&quot;@babel/preset-env&quot;</span><span class="token punctuation">]</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    const moduleInfo <span class="token operator">=</span> <span class="token punctuation">{</span>file,deps,code<span class="token punctuation">}</span>
    <span class="token builtin class-name">return</span> moduleInfo
<span class="token punctuation">}</span>
const parseModules <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const entry <span class="token operator">=</span>  getModuleInfo<span class="token punctuation">(</span>file<span class="token punctuation">)</span>
    const temp <span class="token operator">=</span> <span class="token punctuation">[</span>entry<span class="token punctuation">]</span>
    const depsGraph <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span>let i <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>i<span class="token operator">&lt;</span>temp.length<span class="token punctuation">;</span>i++<span class="token punctuation">)</span><span class="token punctuation">{</span>
        const deps <span class="token operator">=</span> temp<span class="token punctuation">[</span>i<span class="token punctuation">]</span>.deps
        <span class="token keyword">if</span> <span class="token punctuation">(</span>deps<span class="token punctuation">)</span><span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span>const key <span class="token keyword">in</span> deps<span class="token punctuation">)</span><span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span>deps.hasOwnProperty<span class="token punctuation">(</span>key<span class="token punctuation">))</span><span class="token punctuation">{</span>
                    temp.push<span class="token punctuation">(</span>getModuleInfo<span class="token punctuation">(</span>deps<span class="token punctuation">[</span>key<span class="token punctuation">]</span><span class="token punctuation">))</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    temp.forEach<span class="token punctuation">(</span>moduleInfo<span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
        depsGraph<span class="token punctuation">[</span>moduleInfo.file<span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
            deps:moduleInfo.deps,
            code:moduleInfo.code
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token builtin class-name">return</span> depsGraph
<span class="token punctuation">}</span>
// 新增代码
const bundle <span class="token operator">=</span> <span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span><span class="token punctuation">{</span>
    const depsGraph <span class="token operator">=</span> JSON.stringify<span class="token punctuation">(</span>parseModules<span class="token punctuation">(</span>file<span class="token punctuation">))</span>
    <span class="token builtin class-name">return</span> <span class="token variable"><span class="token variable">`</span><span class="token punctuation">(</span>function <span class="token punctuation">(</span>graph<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">function</span> require<span class="token punctuation">(</span>file<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">function</span> absRequire<span class="token punctuation">(</span>relPath<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token builtin class-name">return</span> require<span class="token punctuation">(</span>graph<span class="token punctuation">[</span>file<span class="token punctuation">]</span>.deps<span class="token punctuation">[</span>relPath<span class="token punctuation">]</span><span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
            var exports <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
            <span class="token punctuation">(</span>function <span class="token punctuation">(</span>require,exports,code<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                eval<span class="token punctuation">(</span>code<span class="token punctuation">)</span>
            <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>absRequire,exports,graph<span class="token punctuation">[</span>file<span class="token punctuation">]</span>.code<span class="token punctuation">)</span>
            <span class="token builtin class-name">return</span> exports
        <span class="token punctuation">}</span>
        require<span class="token punctuation">(</span><span class="token string">'${file}'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">(</span>$<span class="token punctuation">{</span>depsGraph<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token variable">`</span></span>

<span class="token punctuation">}</span>
const content <span class="token operator">=</span> bundle<span class="token punctuation">(</span><span class="token string">'./src/index.js'</span><span class="token punctuation">)</span>

console.log<span class="token punctuation">(</span>content<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>来执行下，看看效果
{% asset_img 16.png This is an image %}</p> <p>确实执行成功。接下来，把返回的这段代码写入新创建的文件中</p> <div class="language-bash extra-class"><pre class="language-bash"><code>//写入到我们的dist目录下
fs.exists<span class="token punctuation">(</span><span class="token string">'./dist'</span>, <span class="token punctuation">(</span>exists<span class="token punctuation">)</span> <span class="token operator">=</span><span class="token operator">&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>exists<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        fs.writeFileSync<span class="token punctuation">(</span><span class="token string">'./dist/bundle.js'</span>, content<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        fs.mkdirSync<span class="token punctuation">(</span><span class="token string">'./dist'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        fs.writeFileSync<span class="token punctuation">(</span><span class="token string">'./dist/bundle.js'</span>, content<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><p>至次，我们的手写webpack核心原理就到此结束了。</p> <p>我们参观下生成的bundle.js文件</p> <p>{% asset_img 17.png This is an image %}</p> <p>发现其实就是将我们早期收集的所有依赖作为参数传入到立即执行函数当中，然后通过eval来递归地执行每个依赖的code。</p> <p>现在我们将bundle.js文件引入index.html看看能不能执行</p> <p>{% asset_img 18.png This is an image %}</p> <p>成功。。。。。惊喜。。</p></div></section> <footer class="page-edit"><!----> <!----></footer> <!----> <div class="comments-wrapper"><!----></div></main></div> <!----></div> <ul class="sub-sidebar sub-sidebar-wrapper" style="width:12rem;" data-v-b57cc07c data-v-7dd95ae2><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/write-webpack.html#手写webpack核心原理" class="sidebar-link reco-side-手写webpack核心原理" data-v-b57cc07c>手写webpack核心原理</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/write-webpack.html#一、核心打包原理" class="sidebar-link reco-side-一、核心打包原理" data-v-b57cc07c>一、核心打包原理</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/write-webpack.html#二、基本准备工作" class="sidebar-link reco-side-二、基本准备工作" data-v-b57cc07c>二、基本准备工作</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/write-webpack.html#三、获取模块内容" class="sidebar-link reco-side-三、获取模块内容" data-v-b57cc07c>三、获取模块内容</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/write-webpack.html#四、分析模块" class="sidebar-link reco-side-四、分析模块" data-v-b57cc07c>四、分析模块</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/write-webpack.html#五、收集依赖" class="sidebar-link reco-side-五、收集依赖" data-v-b57cc07c>五、收集依赖</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/write-webpack.html#六、es6转成es5-ast" class="sidebar-link reco-side-六、es6转成es5-ast" data-v-b57cc07c>六、ES6转成ES5（AST）</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/write-webpack.html#七、递归获取所有依赖" class="sidebar-link reco-side-七、递归获取所有依赖" data-v-b57cc07c>七、递归获取所有依赖</a></li><li class="level-2" data-v-b57cc07c><a href="/vuepress-blog/blogs/write-webpack.html#八、处理两个关键字" class="sidebar-link reco-side-八、处理两个关键字" data-v-b57cc07c>八、处理两个关键字</a></li></ul></div></div></div><div class="global-ui"><div class="back-to-ceiling" style="right:1rem;bottom:6rem;width:2.5rem;height:2.5rem;border-radius:.25rem;line-height:2.5rem;display:none;" data-v-c6073ba8 data-v-c6073ba8><svg t="1574745035067" viewBox="0 0 1024 1024" version="1.1" xmlns="http://www.w3.org/2000/svg" p-id="5404" class="icon" data-v-c6073ba8><path d="M526.60727968 10.90185116a27.675 27.675 0 0 0-29.21455937 0c-131.36607665 82.28402758-218.69155461 228.01873535-218.69155402 394.07834331a462.20625001 462.20625001 0 0 0 5.36959153 69.94390903c1.00431239 6.55289093-0.34802892 13.13561351-3.76865779 18.80351572-32.63518765 54.11355614-51.75690182 118.55860487-51.7569018 187.94566865a371.06718723 371.06718723 0 0 0 11.50484808 91.98906777c6.53300375 25.50556257 41.68394495 28.14064038 52.69160883 4.22606766 17.37162448-37.73630017 42.14135425-72.50938081 72.80769204-103.21549295 2.18761121 3.04276886 4.15646224 6.24463696 6.40373557 9.22774369a1871.4375 1871.4375 0 0 0 140.04691725 5.34970492 1866.36093723 1866.36093723 0 0 0 140.04691723-5.34970492c2.24727335-2.98310674 4.21612437-6.18497483 6.3937923-9.2178004 30.66633723 30.70611158 55.4360664 65.4791928 72.80769147 103.21549355 11.00766384 23.91457269 46.15860503 21.27949489 52.69160879-4.22606768a371.15156223 371.15156223 0 0 0 11.514792-91.99901164c0-69.36717486-19.13165746-133.82216804-51.75690182-187.92578088-3.42062944-5.66790279-4.76302748-12.26056868-3.76865837-18.80351632a462.20625001 462.20625001 0 0 0 5.36959269-69.943909c-0.00994388-166.08943902-87.32547796-311.81420293-218.6915546-394.09823051zM605.93803103 357.87693858a93.93749974 93.93749974 0 1 1-187.89594924 6.1e-7 93.93749974 93.93749974 0 0 1 187.89594924-6.1e-7z" p-id="5405" data-v-c6073ba8></path><path d="M429.50777625 765.63860547C429.50777625 803.39355007 466.44236686 1000.39046097 512.00932183 1000.39046097c45.56695499 0 82.4922232-197.00623328 82.5015456-234.7518555 0-37.75494459-36.9345906-68.35043303-82.4922232-68.34111062-45.57627738-0.00932239-82.52019037 30.59548842-82.51086798 68.34111062z" p-id="5406" data-v-c6073ba8></path></svg></div><div class="Sakura" data-v-248d85d6><canvas id="canvas_sakura" style="z-index:-1;" data-v-248d85d6></canvas></div><canvas id="vuepress-canvas-cursor"></canvas><div class="reco-bgm-panel" data-v-b1d3339e><audio id="bgm" src="https://cs-sycdn.kuwo.cn/371642c104355a522300695af11424d3/64db8722/resource/n3/6/44/3638605905.mp3" data-v-b1d3339e></audio> <div class="reco-float-box" style="bottom:20px;z-index:999999;display:none;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><img src="https://img1.kuwo.cn/star/albumcover/500/53/43/1728161476.jpg" data-v-b1d3339e></div> <div class="reco-bgm-box" style="left:10px;bottom:10px;z-index:999999;" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="reco-bgm-cover" style="background-image:url(https://img1.kuwo.cn/star/albumcover/500/53/43/1728161476.jpg);" data-v-b1d3339e><div class="mini-operation" style="display:none;" data-v-b1d3339e><i class="reco-bgm reco-bgm-pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play" style="display:none;" data-v-b1d3339e></i></div> <div class="falut-message" style="display:none;" data-v-b1d3339e>
          播放失败
        </div></div> <div class="reco-bgm-info" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-music music" data-v-b1d3339e></i>可能</div> <div class="info-box" data-v-b1d3339e><i class="reco-bgm reco-bgm-artist" data-v-b1d3339e></i>程响</div> <div class="reco-bgm-progress" data-v-b1d3339e><div class="progress-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div> <div class="reco-bgm-operation" data-v-b1d3339e><i class="reco-bgm reco-bgm-last last" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-pause pause" style="display:none;" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-play play" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-next next" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-volume1 volume" data-v-b1d3339e></i> <i class="reco-bgm reco-bgm-mute mute" style="display:none;" data-v-b1d3339e></i> <div class="volume-bar" data-v-b1d3339e><div class="bar" data-v-b1d3339e></div></div></div></div> <div class="reco-bgm-left-box" data-v-b1d3339e data-v-41bcba48 data-v-b1d3339e><i class="reco-bgm reco-bgm-left" data-v-b1d3339e></i></div></div></div></div></div>
    <script src="/vuepress-blog/assets/js/app.cfe4f1dc.js" defer></script><script src="/vuepress-blog/assets/js/7.a84a24ff.js" defer></script><script src="/vuepress-blog/assets/js/2.c3a99807.js" defer></script><script src="/vuepress-blog/assets/js/1.c178cf32.js" defer></script><script src="/vuepress-blog/assets/js/71.b1ddb05f.js" defer></script>
  </body>
</html>
